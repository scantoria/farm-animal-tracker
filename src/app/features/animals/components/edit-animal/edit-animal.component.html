<form *ngIf="animal" #form="ngForm" (ngSubmit)="onSubmit(form)" class="responsive-form">
  <h2>Edit Animal</h2>

  <!-- Success Message -->
  <div *ngIf="showSuccessMessage" class="alert alert-success">
    {{ successMessage }}
  </div>

  <!-- Animal Image Section -->
  <div class="image-upload-section">
    <label class="section-label">Animal Photo</label>
    <div class="image-container">
      <div class="image-preview" *ngIf="animal.imageUrl">
        <img [src]="animal.imageUrl" [alt]="animal.name" />
        <button type="button" class="btn-remove-image" (click)="removeImage()" title="Remove image">
          <i class="bi bi-x-circle-fill"></i>
        </button>
      </div>
      <div class="image-upload-placeholder" *ngIf="!animal.imageUrl && !isUploadingImage">
        <input
          type="file"
          id="imageInput"
          (change)="onImageSelected($event)"
          accept="image/*"
          hidden
        />
        <label for="imageInput" class="upload-image-label">
          <i class="bi bi-camera"></i>
          <span>Add Photo</span>
        </label>
      </div>
      <div class="image-uploading" *ngIf="isUploadingImage">
        <div class="spinner-small"></div>
        <span>Uploading...</span>
      </div>
    </div>
    <div class="change-image-btn" *ngIf="animal.imageUrl && !isUploadingImage">
      <input type="file" id="changeImageInput" (change)="onImageSelected($event)" accept="image/*" hidden />
      <label for="changeImageInput" class="btn btn-sm btn-secondary">
        <i class="bi bi-pencil me-1"></i> Change Photo
      </label>
    </div>
    <div class="upload-error" *ngIf="imageUploadError">
      <i class="bi bi-exclamation-triangle me-1"></i>{{ imageUploadError }}
    </div>
  </div>

  <!-- Input for Name -->
  <div class="form-group">
    <label for="name">Animal name or Tag:</label>
    <input type="text" id="name" name="name" [(ngModel)]="animal.name" required #name="ngModel">
    <div class="validation-message" *ngIf="name.invalid && (name.dirty || name.touched)">
      <div *ngIf="name.errors?.['required']">
        Name is required.
      </div>
    </div>
  </div>

  <!-- Input for Species -->
  <div class="form-group">
    <label for="species">Species:</label>
    <input type="text" id="species" name="species" [(ngModel)]="animal.species" required #species="ngModel">
    <div class="validation-message" *ngIf="species.invalid && (species.dirty || species.touched)">
      <div *ngIf="species.errors?.['required']">
        Species is required.
      </div>
    </div>
  </div>

  <!-- Input for Breed -->
  <div class="form-group">
    <label for="breed">Breed:</label>
    <input type="text" id="breed" name="breed" [(ngModel)]="animal.breed" required #breed="ngModel">
    <div class="validation-message" *ngIf="breed.invalid && (breed.dirty || breed.touched)">
      <div *ngIf="breed.errors?.['required']">
        Breed is required.
      </div>
    </div>
  </div>

  <!-- Input for Date of Birth -->
  <div class="form-group">
    <label for="dob">Date of Birth:</label>
    <input type="date" id="dob" name="dob" [(ngModel)]="dobString" required #dob="ngModel">
    <div class="validation-message" *ngIf="dob.invalid && (dob.dirty || dob.touched)">
      <div *ngIf="dob.errors?.['required']">
        Date of Birth is required.
      </div>
    </div>
  </div>

  <!-- Select for Sex -->
  <div class="form-group">
    <label for="sex">Sex:</label>
    <select id="sex" name="sex" [(ngModel)]="animal.sex" required #sex="ngModel" (change)="onSexChange($event)">
      <option value="" disabled>Select Sex</option>
      <option value="female">Female</option>
      <option value="male">Male</option>
    </select>
    <div class="validation-message" *ngIf="sex.invalid && (sex.dirty || sex.touched)">
      <div *ngIf="sex.errors?.['required']">
        Sex is required.
      </div>
    </div>
  </div>

  <!-- Reproductive Status -->
  <div class="form-group">
    <label for="reproductiveStatus">Reproductive Status:</label>
    <select id="reproductiveStatus" name="reproductiveStatus" [(ngModel)]="animal.reproductiveStatus" class="form-control">
      <option value="" disabled>Select reproductive status...</option>
      <option value="unknown">Unknown</option>
      <option *ngFor="let option of reproductiveStatusOptions" [value]="option.value">
        {{ option.label }}
      </option>
    </select>
  </div>

  <!-- Input for Status -->
  <div class="form-group">
    <label for="status">Status:</label>
    <select id="status" name="status" [(ngModel)]="animal.status" required #status="ngModel" class="form-control">
      <option value="" disabled>Select status...</option>
      <option value="active">Active</option>
      <option value="sold">Sold</option>
      <option value="deceased">Deceased</option>
    </select>
    <div class="validation-message" *ngIf="status.invalid && (status.dirty || status.touched)">
      <div *ngIf="status.errors?.['required']">
        Status is required.
      </div>
    </div>
  </div>

  <!-- Bloodline / Parentage Section -->
  <div class="form-section">
    <h3 class="section-title">Bloodline / Parentage</h3>

    <!-- Sire (Father) Field -->
    <div class="form-group">
      <label for="sireId">Sire (Father):</label>
      <select id="sireId" name="sireId" [(ngModel)]="animal.sireId" class="form-control">
        <option [value]="undefined">Unknown / Not in system</option>
        <option *ngFor="let sireOption of registrySires" [value]="sireOption.id">
          {{ sireOption.name }} - {{ sireOption.breed }} ({{ getSourceLabel(sireOption.source) }})
        </option>
      </select>
      <small class="form-text text-muted" *ngIf="registrySires.length === 0">
        No sires found for this species. Add sires in the Bulls/Sire/Buck Registry.
      </small>
    </div>

    <!-- Dam (Mother) Field -->
    <div class="form-group">
      <label for="damId">Dam (Mother):</label>
      <select id="damId" name="damId" [(ngModel)]="animal.damId" class="form-control">
        <option [value]="undefined">Unknown / Not in system</option>
        <option *ngFor="let damOption of potentialDams" [value]="damOption.id">
          {{ damOption.name }} ({{ damOption.breed }})
        </option>
      </select>
      <div class="parent-info" *ngIf="dam">
        <small class="text-muted">Current: {{ dam.name }} - {{ dam.breed }}</small>
      </div>
    </div>
  </div>

  <!-- Current Farm Assignment -->
  <div class="form-group">
    <label for="currentFarmId">Current Farm Location:</label>
    <select id="currentFarmId" name="currentFarmId" [(ngModel)]="animal.currentFarmId" class="form-control">
      <option [value]="undefined">None</option>
      <option *ngFor="let farm of farms" [value]="farm.id">{{ farm.name }}</option>
    </select>
  </div>

  <!-- Action buttons section -->
  <div class="form-actions">
    <button type="button" class="btn btn-danger" (click)="onDeleteAnimal()">
      <i class="bi bi-trash me-1"></i> Delete Animal
    </button>
    <button type="submit" [disabled]="form.invalid" class="btn btn-primary">Update Animal</button>
  </div>
</form>

<!-- Current Location Card -->
<div class="location-card">
  <div class="location-header">
    <div class="location-icon">üè†</div>
    <h3>Current Location</h3>
  </div>
  <div class="location-content">
    <div class="location-info">
      <div class="location-name">
        <span *ngIf="currentFarm">{{ currentFarm.name }}</span>
        <span *ngIf="!currentFarm" class="not-assigned">Not Assigned</span>
      </div>
      <div class="location-date" *ngIf="currentFarm && movementHistory.length > 0">
        Assigned since: {{ getMovementDateAssigned() }}
      </div>
    </div>
    <button type="button" class="btn btn-secondary btn-sm" (click)="openTransferDialog()">
      <i class="bi bi-arrow-left-right me-1"></i> Transfer to Different Farm
    </button>
  </div>
</div>

<form *ngIf="animal" #form="ngForm">
  <hr />

  <!-- Navigation buttons section -->
  <div class="navigation-buttons">
    <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
      [routerLink]="['/animals', animal.id, 'health']">
      <span>Health Records</span>
      <i class="bi bi-chevron-right"></i>
    </a>
    <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
      [routerLink]="['/animals', animal.id, 'weight']">
      <span><i class="bi bi-speedometer2 me-2"></i>Weight Records</span>
      <i class="bi bi-chevron-right"></i>
    </a>
    <a *ngIf="animal.sex === 'female'"
      class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
      [routerLink]="['/animals', animal.id, 'birth-events']">
      <span><i class="bi bi-balloon-heart me-2"></i>Birth Events / Calves</span>
      <i class="bi bi-chevron-right"></i>
    </a>
    <a *ngIf="animal.sex === 'female'"
      class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
      [routerLink]="['/animals', animal.id, 'hormone-treatments']">
      <span><i class="bi bi-capsule me-2"></i>Hormone Treatments</span>
      <i class="bi bi-chevron-right"></i>
    </a>
    <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
      [routerLink]="['/animals', animal.id, 'breeding']">
      <span>Breeding Events</span>
      <i class="bi bi-chevron-right"></i>
    </a>
    <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
      [routerLink]="['/animals', animal.id, 'weaning']">
      <span>Weaning Schedules</span>
      <i class="bi bi-chevron-right"></i>
    </a>
    <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
      [routerLink]="['/animals', animal.id, 'blacksmith']">
      <span>Blacksmith Visits</span>
      <i class="bi bi-chevron-right"></i>
    </a>
    <a
      class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
      [routerLink]="['/animals', animal.id, 'veterinarian-visit']">
      <span>Veterinarian Visits</span>
      <i class="bi bi-chevron-right"></i>
    </a>
    <a
      class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
      [routerLink]="['/animals', animal.id, 'medication-record']">
      <span>Medication/Treatments</span>
      <i class="bi bi-chevron-right"></i>
    </a>
  </div>
</form>

<!-- Documents Section -->
<div class="documents-section" *ngIf="animal">
  <div class="section-header">
    <h3><i class="bi bi-folder2-open me-2"></i>Documents</h3>
    <span class="document-count">{{ documents.length }} file{{ documents.length !== 1 ? 's' : '' }}</span>
  </div>

  <!-- Upload Form -->
  <div class="upload-form">
    <div class="upload-row">
      <div class="form-group">
        <label for="documentType" class="form-label">Document Type</label>
        <select
          id="documentType"
          [(ngModel)]="selectedDocumentType"
          class="form-control"
          name="documentType"
        >
          <option value="" disabled>Select document type...</option>
          <option *ngFor="let type of getDocumentTypeKeys()" [value]="type">
            {{ documentTypeOptions[type] }}
          </option>
        </select>
      </div>
      <div class="form-group description-field">
        <label for="documentDescription" class="form-label">Description (Optional)</label>
        <input
          type="text"
          id="documentDescription"
          [(ngModel)]="documentDescription"
          class="form-control"
          name="documentDescription"
          placeholder="Brief description of the document"
        />
      </div>
    </div>

    <div class="upload-area" [class.uploading]="isUploading">
      <input
        type="file"
        id="fileInput"
        (change)="onFileSelected($event)"
        [accept]="acceptedFileTypes"
        [disabled]="isUploading"
        hidden
      />
      <label for="fileInput" class="upload-label" *ngIf="!isUploading">
        <i class="bi bi-cloud-upload"></i>
        <span class="upload-text">Click to upload or drag and drop</span>
        <span class="upload-hint">PDF, Images, Word, Excel (Max 10MB)</span>
      </label>
      <div class="upload-progress" *ngIf="isUploading">
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="uploadProgress"></div>
        </div>
        <span class="progress-text">Uploading... {{ uploadProgress | number:'1.0-0' }}%</span>
      </div>
    </div>

    <div class="upload-error" *ngIf="uploadError">
      <i class="bi bi-exclamation-triangle me-1"></i>
      {{ uploadError }}
    </div>
  </div>

  <!-- Document List -->
  <div class="document-list" *ngIf="documents.length > 0">
    <div class="document-item" *ngFor="let doc of documents">
      <div class="document-icon">
        <i class="bi" [ngClass]="getFileIcon(doc.fileType)"></i>
      </div>
      <div class="document-info">
        <a [href]="doc.downloadUrl" target="_blank" class="document-name">
          {{ doc.originalName }}
        </a>
        <div class="document-meta">
          <span class="document-type-badge">{{ getDocumentTypeLabel(doc.documentType) }}</span>
          <span class="document-size">{{ formatFileSize(doc.fileSize) }}</span>
        </div>
        <p class="document-description" *ngIf="doc.description">{{ doc.description }}</p>
      </div>
      <div class="document-actions">
        <a [href]="doc.downloadUrl" target="_blank" class="btn btn-sm btn-outline-primary" title="Download">
          <i class="bi bi-download"></i>
        </a>
        <button type="button" class="btn btn-sm btn-outline-danger" (click)="deleteDocument(doc)" title="Delete">
          <i class="bi bi-trash"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div class="no-documents" *ngIf="documents.length === 0">
    <i class="bi bi-file-earmark-x"></i>
    <p>No documents uploaded yet</p>
    <span>Upload registration papers, health certificates, or other supporting documents</span>
  </div>
</div>

<!-- Movement History Section -->
<div class="movement-history-section" *ngIf="movementHistory.length > 0">
  <h3>Movement History</h3>
  <div class="timeline">
    <div class="timeline-item" *ngFor="let movement of movementHistory">
      <div class="timeline-marker"></div>
      <div class="timeline-content">
        <div class="movement-header">
          <span class="movement-date">{{ movement.movementDate }}</span>
          <span class="movement-reason" *ngIf="movement.reason">{{ movement.reason }}</span>
        </div>
        <div class="movement-details">
          <span *ngIf="movement.fromFarmId">from {{ movement.fromFarmName || 'Unknown Farm' }}</span>
          <i class="bi bi-arrow-right mx-1"></i>
          <span>to {{ movement.toFarmName || 'Unknown Farm' }}</span>
        </div>
        <p class="movement-notes" *ngIf="movement.notes">{{ movement.notes }}</p>
      </div>
    </div>
  </div>
</div>

<!-- Transfer Dialog -->
<div class="modal-overlay" *ngIf="showTransferDialog" (click)="closeTransferDialog()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Transfer Animal to Different Farm</h3>
      <button type="button" class="btn-close" (click)="closeTransferDialog()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>

    <div class="modal-body">
      <div class="form-group">
        <label for="transferDestinationFarmId" class="form-label">
          Destination Farm <span class="required">*</span>
        </label>
        <select
          id="transferDestinationFarmId"
          [(ngModel)]="transferDestinationFarmId"
          class="form-control"
          name="transferDestinationFarmId"
        >
          <option value="">Select destination farm...</option>
          <option *ngFor="let farm of farms" [value]="farm.id">{{ farm.name }}</option>
        </select>
      </div>

      <div class="form-group">
        <label for="transferReason" class="form-label">Reason (Optional)</label>
        <input
          type="text"
          id="transferReason"
          [(ngModel)]="transferReason"
          class="form-control"
          name="transferReason"
          placeholder="e.g., Winter Housing, Breeding"
        />
      </div>

      <div class="form-group">
        <label for="transferNotes" class="form-label">Notes (Optional)</label>
        <textarea
          id="transferNotes"
          [(ngModel)]="transferNotes"
          rows="3"
          class="form-control"
          name="transferNotes"
          placeholder="Add any additional notes..."
        ></textarea>
      </div>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="closeTransferDialog()">
        Cancel
      </button>
      <button
        type="button"
        class="btn btn-primary"
        [disabled]="!transferDestinationFarmId"
        (click)="confirmTransfer()"
      >
        <i class="bi bi-check-circle me-1"></i> Confirm Transfer
      </button>
    </div>
  </div>
</div>
