<div class="page-container">

  <!-- Header Section -->
  <div class="header-bar">
    <div class="header-content">
      <button type="button" class="btn-back" (click)="cancel()">
        <i class="bi bi-arrow-left"></i>
      </button>
      <div class="header-text">
        <h1>Bulk Transfer Animals</h1>
        <p class="subtitle" *ngIf="currentFarm">From {{ currentFarm.name }}</p>
        <p class="subtitle" *ngIf="!currentFarm">Assign animals to a farm</p>
      </div>
    </div>
  </div>

  <!-- Form Container -->
  <div class="form-container">

    <!-- Animal Selection Section -->
    <div class="section-card">
      <div class="section-header">
        <h2>Select Animals <span class="count-badge">({{ selectedCount }} selected)</span></h2>
        <div class="selection-actions">
          <button type="button" class="btn btn-sm btn-secondary" (click)="selectAll()">
            <i class="bi bi-check-all me-1"></i> Select All
          </button>
          <button type="button" class="btn btn-sm btn-secondary" (click)="clearAll()">
            <i class="bi bi-x-circle me-1"></i> Clear All
          </button>
        </div>
      </div>

      <!-- Filters -->
      <div class="filters-section">
        <div class="filter-grid">
          <div class="filter-item">
            <label for="searchText">Search</label>
            <input
              type="text"
              id="searchText"
              [(ngModel)]="searchText"
              (ngModelChange)="onFilterChange()"
              placeholder="Search by name or tag..."
              class="form-control"
            />
          </div>

          <div class="filter-item">
            <label for="filterSpecies">Species</label>
            <select
              id="filterSpecies"
              [(ngModel)]="filterSpecies"
              (ngModelChange)="onFilterChange()"
              class="form-control"
            >
              <option value="">All Species</option>
              <option *ngFor="let species of uniqueSpecies" [value]="species">{{ species }}</option>
            </select>
          </div>

          <div class="filter-item">
            <label for="filterCurrentFarm">Current Farm</label>
            <select
              id="filterCurrentFarm"
              [(ngModel)]="filterCurrentFarm"
              (ngModelChange)="onFilterChange()"
              class="form-control"
            >
              <option value="">All Farms</option>
              <option value="none">Not Assigned</option>
              <option *ngFor="let farm of farms" [value]="farm.id">{{ farm.name }}</option>
            </select>
          </div>

          <div class="filter-item">
            <label for="filterStatus">Status</label>
            <select
              id="filterStatus"
              [(ngModel)]="filterStatus"
              (ngModelChange)="onFilterChange()"
              class="form-control"
            >
              <option value="">All Statuses</option>
              <option value="active">Active</option>
              <option value="sold">Sold</option>
              <option value="deceased">Deceased</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Animals List -->
      <div class="animals-list" *ngIf="filteredSelections.length > 0; else noAnimals">
        <div
          class="animal-item"
          *ngFor="let selection of filteredSelections"
          [class.selected]="selection.selected"
          (click)="toggleSelection(selection)"
        >
          <div class="checkbox-wrapper">
            <input
              type="checkbox"
              [checked]="selection.selected"
              (click)="$event.stopPropagation()"
              (change)="toggleSelection(selection)"
            />
          </div>
          <div class="animal-info">
            <h3>{{ selection.animal.name }}</h3>
            <div class="animal-details">
              <span class="detail"><i class="bi bi-tag"></i> {{ selection.animal.identifier || 'No tag' }}</span>
              <span class="detail"><i class="bi bi-gender-ambiguous"></i> {{ selection.animal.species }}</span>
              <span class="detail"><i class="bi bi-house-door"></i> {{ getFarmName(selection.animal.currentFarmId) }}</span>
            </div>
            <p class="breed">{{ selection.animal.breed }}</p>
          </div>
        </div>
      </div>

      <ng-template #noAnimals>
        <div class="empty-state">
          <i class="bi bi-search"></i>
          <p>No animals match your filters</p>
        </div>
      </ng-template>
    </div>

    <!-- Destination Section -->
    <div class="section-card">
      <h2>Transfer Destination</h2>

      <div class="form-group">
        <label for="destinationFarmId" class="form-label">
          Move to Farm <span class="required">*</span>
        </label>
        <select
          id="destinationFarmId"
          [(ngModel)]="destinationFarmId"
          class="form-control"
          required
        >
          <option value="">Select destination farm...</option>
          <option *ngFor="let farm of farms" [value]="farm.id">{{ farm.name }}</option>
        </select>
      </div>

      <div class="form-group">
        <label for="reason" class="form-label">Reason for Move (Optional)</label>
        <select
          id="reason"
          [(ngModel)]="reason"
          class="form-control"
        >
          <option value="">Select reason...</option>
          <option *ngFor="let r of movementReasons" [value]="r">{{ r }}</option>
        </select>
      </div>

      <div class="form-group">
        <label for="notes" class="form-label">Notes (Optional)</label>
        <textarea
          id="notes"
          [(ngModel)]="notes"
          rows="3"
          class="form-control"
          placeholder="Add any additional notes about this transfer..."
        ></textarea>
      </div>
    </div>

    <!-- Form Actions -->
    <div class="form-actions">
      <button type="button" class="btn btn-secondary" (click)="cancel()">
        <i class="bi bi-x-circle me-1"></i> Cancel
      </button>
      <button
        type="button"
        class="btn btn-primary"
        [disabled]="selectedCount === 0 || !destinationFarmId"
        (click)="showConfirmDialog()"
      >
        <i class="bi bi-arrow-left-right me-1"></i> Transfer Animals
      </button>
    </div>

  </div>

</div>

<!-- Confirmation Dialog -->
<div class="modal-overlay" *ngIf="showConfirmation" (click)="cancelConfirmation()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Confirm Transfer</h3>
      <button type="button" class="btn-close" (click)="cancelConfirmation()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>

    <div class="modal-body">
      <p class="confirm-message">
        Transfer <strong>{{ selectedCount }} animal<span *ngIf="selectedCount !== 1">s</span></strong> to <strong>{{ getDestinationFarmName() }}</strong>?
      </p>

      <div class="selected-animals-list">
        <h4>Selected Animals:</h4>
        <ul>
          <li *ngFor="let animal of selectedAnimals">
            {{ animal.name }} ({{ animal.species }})
          </li>
        </ul>
      </div>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="cancelConfirmation()" [disabled]="isSubmitting">
        Cancel
      </button>
      <button type="button" class="btn btn-primary" (click)="confirmTransfer()" [disabled]="isSubmitting">
        <span *ngIf="!isSubmitting">
          <i class="bi bi-check-circle me-1"></i> Confirm Transfer
        </span>
        <span *ngIf="isSubmitting">
          <span class="spinner-small"></span> Transferring...
        </span>
      </button>
    </div>
  </div>
</div>
